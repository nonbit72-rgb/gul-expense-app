<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0f172a">
<title>GUL Ultra Expense Manager</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="manifest" href="manifest.json">

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#0f172a,#1e293b);
  color:#e2e8f0;
}
h1{text-align:center;padding:15px 0;margin:0;}

.section{display:none;padding:15px 15px 100px;}

.card{
  background:#1e293b;
  padding:15px;
  margin:15px 0;
  border-radius:15px;
  box-shadow:0 0 15px rgba(0,0,0,0.4);
}

input,select,button{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:8px;
  border:none;
}

button{
  background:#3b82f6;
  color:white;
  font-weight:bold;
  cursor:pointer;
}
button:hover{background:#2563eb;}

.expenseItem{
  background:#0f172a;
  padding:12px;
  margin:10px 0;
  border-radius:12px;
  box-shadow:0 0 10px rgba(0,0,0,0.3);
}

.expenseItem button{
  width:auto;
  padding:5px 10px;
  margin-top:5px;
  margin-right:5px;
  font-size:12px;
}

.bottomNav{
  position:fixed;
  bottom:0;
  width:100%;
  background:#111827;
  display:flex;
  justify-content:space-around;
  padding:10px 0;
  box-shadow:0 -3px 10px rgba(0,0,0,0.4);
}

.bottomNav button{
  background:none;
  color:#e2e8f0;
  font-size:14px;
}

.stat{margin:5px 0;font-size:14px;}
</style>
</head>

<body>

<h1>GUL Expense Manager</h1>

<!-- HOME -->
<div id="homeSection" class="section">
  <div class="card">
    <div id="time" class="stat"></div>
    <div id="total" class="stat"></div>
    <div id="avgMonth" class="stat"></div>
    <div id="avgDay" class="stat"></div>
    <div id="avgHour" class="stat"></div>
    <div id="avgMinute" class="stat"></div>
    <canvas id="miniChart" height="90"></canvas>
  </div>
</div>

<!-- ADD -->
<div id="addSection" class="section">
  <div class="card">
    <select id="category">
      <option>Food</option>
      <option>Travel</option>
      <option>Shopping</option>
      <option>College Expense</option>
      <option>Other</option>
    </select>
    <input type="number" id="amount" placeholder="Amount">
    <input type="text" id="description" placeholder="Description">
    <input type="datetime-local" id="customTime">
    <button onclick="addExpense()">Add Expense</button>
  </div>
</div>

<!-- LIST -->
<div id="listSection" class="section">
  <div class="card">
    <input type="text" id="searchInput" placeholder="Search..." onkeyup="renderExpenses()">
    <div id="expenseList"></div>
  </div>
</div>

<div class="bottomNav">
  <button onclick="showSection('homeSection')">Home</button>
  <button onclick="showSection('addSection')">Add</button>
  <button onclick="showSection('listSection')">Expenses</button>
</div>

<script>

/* ================= GLOBAL ================= */

let expenses = JSON.parse(localStorage.getItem("gulData")) || [];
let previousTotal = 0;
let miniChart;

/* ================= NAVIGATION ================= */

function showSection(id){
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}
showSection("homeSection");

/* ================= ADD ================= */

function addExpense(){

  const category = document.getElementById("category").value;
  const amount = parseFloat(document.getElementById("amount").value);
  const description = document.getElementById("description").value;
  const customTime = document.getElementById("customTime").value;

  if(!amount) return;

  const finalTime = customTime ? new Date(customTime) : new Date();

  expenses.push({
    id: Date.now(),
    category,
    amount,
    description,
    date: finalTime.toISOString()
  });

  localStorage.setItem("gulData", JSON.stringify(expenses));

  document.getElementById("amount").value="";
  document.getElementById("description").value="";
  document.getElementById("customTime").value="";

  renderExpenses();
  updateHome();
}

/* ================= DELETE ================= */

function deleteExpense(id){
  expenses = expenses.filter(e=>e.id!==id);
  localStorage.setItem("gulData", JSON.stringify(expenses));
  renderExpenses();
  updateHome();
}

/* ================= EDIT ================= */

function editExpense(id){

  const exp = expenses.find(e=>e.id===id);
  if(!exp) return;

  const newAmount = prompt("Edit Amount:", exp.amount);
  const newDesc = prompt("Edit Description:", exp.description);

  if(newAmount!==null && !isNaN(newAmount)){
    exp.amount = parseFloat(newAmount);
  }

  if(newDesc!==null){
    exp.description = newDesc;
  }

  localStorage.setItem("gulData", JSON.stringify(expenses));
  renderExpenses();
  updateHome();
}

/* ================= COST PER CALCULATION ================= */
/* Advanced per-expense time logic — unchanged */

function calculateCostPer(){

  const now = new Date();

  let costMonth=0;
  let costDay=0;
  let costHour=0;
  let costMinute=0;

  expenses.forEach(e=>{

    const expenseTime = new Date(e.date);
    const diffMs = now - expenseTime;

    const minutes = Math.max(1, Math.floor(diffMs/60000));
    const hours   = Math.max(1, Math.floor(diffMs/3600000));
    const days    = Math.max(1, Math.floor(diffMs/86400000));
    const months  = Math.max(1, Math.floor(days/30.44));

    costMinute += e.amount / minutes;
    costHour   += e.amount / hours;
    costDay    += e.amount / days;
    costMonth  += e.amount / months;

  });

  return {costMonth, costDay, costHour, costMinute};
}

/* ================= HOME ================= */

function updateHome(){

  const now = new Date();
  const total = expenses.reduce((s,e)=>s+e.amount,0);
  const change = total - previousTotal;

  const color = change > 0 ? "#ef4444" : "#22c55e";

  document.getElementById("time").innerHTML =
    "Time: " + now.toLocaleTimeString();

  document.getElementById("total").innerHTML =
    `Total ₹${total.toFixed(2)}
     <span style="color:${color}">
     ${change>=0?"▲":"▼"} ${Math.abs(change).toFixed(2)}</span>`;

  const costs = calculateCostPer();

  document.getElementById("avgMonth").innerHTML =
    "Cost per Month ₹" + costs.costMonth.toFixed(2);

  document.getElementById("avgDay").innerHTML =
    "Cost per Day ₹" + costs.costDay.toFixed(2);

  document.getElementById("avgHour").innerHTML =
    "Cost per Hour ₹" + costs.costHour.toFixed(4);

  document.getElementById("avgMinute").innerHTML =
    "Cost per Minute ₹" + costs.costMinute.toFixed(6);

  updateMiniChart(total, color);

  previousTotal = total;
}

/* ================= MINI CHART ================= */

function initChart(){

  miniChart = new Chart(
    document.getElementById("miniChart"),
    {
      type:"line",
      data:{
        labels:[],
        datasets:[{
          data:[],
          borderWidth:2,
          tension:0.4,
          pointRadius:0
        }]
      },
      options:{
        plugins:{legend:{display:false}},
        scales:{
          x:{display:false},
          y:{display:true}
        }
      }
    }
  );
}

function updateMiniChart(value,color){

  miniChart.data.labels.push("");
  miniChart.data.datasets[0].data.push(value);
  miniChart.data.datasets[0].borderColor = color;

  if(miniChart.data.labels.length > 20){
    miniChart.data.labels.shift();
    miniChart.data.datasets[0].data.shift();
  }

  miniChart.update();
}

/* ================= RENDER ================= */

function renderExpenses(){

  const container = document.getElementById("expenseList");
  container.innerHTML = "";

  const search = document.getElementById("searchInput").value.toLowerCase();

  expenses.forEach(e=>{

    const combined = (
      e.category + " " +
      e.amount + " " +
      e.description + " " +
      new Date(e.date).toLocaleString()
    ).toLowerCase();

    if(!combined.includes(search)) return;

    container.innerHTML += `
      <div class="expenseItem">
        <b>${e.category}</b> ₹${e.amount}<br>
        ${e.description}<br>
        ${new Date(e.date).toLocaleString()}<br>
        <button onclick="editExpense(${e.id})">Edit</button>
        <button onclick="deleteExpense(${e.id})">Delete</button>
      </div>`;
  });
}

/* ================= LOOP ================= */

setInterval(()=>{
  if(document.getElementById("homeSection").style.display !== "none"){
    updateHome();
  }
},1000);

/* ================= INIT ================= */

initChart();
renderExpenses();
updateHome();

</script>
</body>
</html>
