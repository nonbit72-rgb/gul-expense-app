<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#0f172a">
<title>GUL Ultra Expense Manager</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="manifest" href="manifest.json">

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>

<style>
body{
    background:#0f172a;
    color:#e2e8f0;
    font-family:Arial;
    padding:15px;
    margin:0;
}
h1{text-align:center;}

.card{
    background:#1e293b;
    padding:15px;
    margin:10px 0;
    border-radius:10px;
}

input,select,button{
    padding:10px;
    margin:5px 0;
    border-radius:5px;
    border:none;
    width:100%;
}

button{
    background:#3b82f6;
    color:white;
    cursor:pointer;
}

button:hover{ background:#2563eb; }

.stat{
    margin:5px 0;
}

.section{ margin-bottom:80px; }

.bottomNav{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#1e293b;
  display:flex;
  justify-content:space-around;
  padding:10px 0;
}

.bottomNav button{
  background:none;
  color:#e2e8f0;
  font-size:14px;
}
.bottomNav button:hover{ color:#3b82f6; }

.expenseItem{
  background:#0f172a;
  padding:10px;
  margin:5px 0;
  border-radius:8px;
}
</style>
</head>

<body>

<h1>GUL Expense Manager</h1>

<!-- ================= HOME ================= -->
<div id="homeSection" class="section">
  <div class="card">
    <div class="stat" id="time"></div>
    <div class="stat" id="total"></div>
    <div class="stat" id="avgMonth"></div>
    <div class="stat" id="avgDay"></div>
    <div class="stat" id="avgHour"></div>
    <div class="stat" id="avgMinute"></div>
    <canvas id="miniChart" height="80"></canvas>
  </div>
</div>

<!-- ================= ADD ================= -->
<div id="addSection" class="section" style="display:none;">
  <div class="card">
    <select id="category">
      <option>Food</option>
      <option>Travel</option>
      <option>Shopping</option>
      <option>College Expense</option>
      <option>Other</option>
    </select>

    <input type="number" id="amount" placeholder="Amount">
    <input type="text" id="description" placeholder="Description">
    <input type="datetime-local" id="customTime">
    <button onclick="addExpense()">Add Expense</button>
  </div>
</div>

<!-- ================= LIST ================= -->
<div id="listSection" class="section" style="display:none;">
  <div class="card">
    <input type="text" id="searchInput" placeholder="Search (category, price, desc, time)" onkeyup="renderExpenses()">
    <div id="expenseList"></div>
  </div>
</div>

<!-- ================= NAV ================= -->
<div class="bottomNav">
  <button onclick="showSection('homeSection')">Home</button>
  <button onclick="showSection('addSection')">Add</button>
  <button onclick="showSection('listSection')">Expenses</button>
</div>

<script>

/* ================= GLOBAL ================= */

let expenses = JSON.parse(localStorage.getItem("gulData")) || [];
let previousTotal = 0;
let chart;
let chartData = [];

/* ================= NAVIGATION ================= */

function showSection(id){
  document.querySelectorAll(".section").forEach(s=>s.style.display="none");
  document.getElementById(id).style.display="block";
}

/* ================= ADD EXPENSE ================= */

function addExpense(){

  let category = document.getElementById("category").value;
  let amount = parseFloat(document.getElementById("amount").value);
  let description = document.getElementById("description").value;
  let customTime = document.getElementById("customTime").value;

  if(!amount) return;

  let finalTime = customTime ? new Date(customTime) : new Date();

  expenses.push({
    id: Date.now(),
    category,
    amount,
    description,
    date: finalTime.toISOString()
  });

  localStorage.setItem("gulData", JSON.stringify(expenses));
  document.getElementById("amount").value="";
  document.getElementById("description").value="";
  document.getElementById("customTime").value="";

  renderExpenses();
}

/* ================= DELETE ================= */

function deleteExpense(id){
  expenses = expenses.filter(e=>e.id!==id);
  localStorage.setItem("gulData", JSON.stringify(expenses));
  renderExpenses();
}

/* ================= EDIT ================= */

function editExpense(id){
  let exp = expenses.find(e=>e.id===id);
  if(!exp) return;

  let newAmount = prompt("Edit Amount:", exp.amount);
  let newDesc = prompt("Edit Description:", exp.description);

  if(newAmount!==null) exp.amount = parseFloat(newAmount);
  if(newDesc!==null) exp.description = newDesc;

  localStorage.setItem("gulData", JSON.stringify(expenses));
  renderExpenses();
}

/* ================= TOTAL ================= */

function getTotal(){
  return expenses.reduce((sum,e)=>sum+e.amount,0);
}

/* ================= ADVANCED AVERAGE LOGIC ================= */

function calculateDynamicAverages(){

  let now = new Date();
  let avgMonth=0, avgDay=0, avgHour=0, avgMinute=0;

  expenses.forEach(e=>{

    let expenseTime = new Date(e.date);
    let diffMs = now - expenseTime;

    let minutes = Math.max(1, Math.floor(diffMs/60000));
    let hours   = Math.max(1, Math.floor(diffMs/3600000));
    let days    = Math.max(1, Math.floor(diffMs/86400000));
    let months  = Math.max(1, Math.floor(days/30.44));

    avgMinute += e.amount / minutes;
    avgHour   += e.amount / hours;
    avgDay    += e.amount / days;
    avgMonth  += e.amount / months;

  });

  return {avgMonth, avgDay, avgHour, avgMinute};
}

/* ================= HOME LIVE ================= */

function updateHome(){

  let now = new Date();
  let total = getTotal();

  let change = total - previousTotal;
  let arrow = change>=0 ? "▲" : "▼";
  let color = change>=0 ? "#22c55e" : "#ef4444";

  document.getElementById("time").innerHTML =
    "Market Time: "+now.toLocaleTimeString();

  document.getElementById("total").innerHTML =
    `Total: ₹${total.toFixed(2)}
     <span style="color:${color}">${arrow} ${Math.abs(change).toFixed(2)}</span>`;

  let avgs = calculateDynamicAverages();

  document.getElementById("avgMonth").innerHTML =
    "Avg / Month: ₹"+avgs.avgMonth.toFixed(2);

  document.getElementById("avgDay").innerHTML =
    "Avg / Day: ₹"+avgs.avgDay.toFixed(2);

  document.getElementById("avgHour").innerHTML =
    "Avg / Hour: ₹"+avgs.avgHour.toFixed(4);

  document.getElementById("avgMinute").innerHTML =
    "Avg / Minute: ₹"+avgs.avgMinute.toFixed(6);

  updateChart(total);

  previousTotal = total;
}

/* ================= CHART ================= */

function initChart(){
  chart = new Chart(document.getElementById("miniChart"),{
    type:"line",
    data:{
      labels:[],
      datasets:[{
        data:[],
        borderColor:"#22c55e",
        tension:0.4,
        pointRadius:0
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{x:{display:false},y:{display:false}}
    }
  });
}

function updateChart(value){
  let label = new Date().toLocaleTimeString();
  chartData.push(value);
  chart.data.labels.push(label);
  chart.data.datasets[0].data.push(value);

  if(chartData.length>20){
    chartData.shift();
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }

  chart.update();
}

/* ================= RENDER EXPENSES ================= */

function renderExpenses(){

  let container = document.getElementById("expenseList");
  container.innerHTML="";

  let search = document.getElementById("searchInput").value.toLowerCase();

  expenses.forEach(e=>{

    let combined =
      e.category+" "+
      e.amount+" "+
      e.description+" "+
      new Date(e.date).toLocaleString();

    if(!combined.toLowerCase().includes(search)) return;

    let div=document.createElement("div");
    div.className="expenseItem";

    div.innerHTML=`
      <strong>${e.category}</strong> - ₹${e.amount}<br>
      ${e.description}<br>
      ${new Date(e.date).toLocaleString()}<br>
      <button onclick="editExpense(${e.id})">Edit</button>
      <button onclick="deleteExpense(${e.id})">Delete</button>
    `;

    container.appendChild(div);
  });
}

/* ================= LIVE UPDATE ================= */

setInterval(()=>{
  if(document.getElementById("homeSection").style.display!=="none"){
    updateHome();
  }
},1000);

initChart();
renderExpenses();
updateHome();

</script>
</body>
</html>
